---
title: "4_cpa_report_lavaan"
output: html_document
---

#1. Setup

```{r Setup, include=FALSE}
# Sets pseudo random number generator seed to fixed value for reproducibility
set.seed(1)

# Check if package 'here' is installed; if not, install. 
if (!require("here")) install.packages("here")

# Load 'here' package
library(here)

# Check if renv file exists in project directory
if (file.exists(here("renv.lock")))

{
  
  if (!require("renv")) {
    
    install.packages("renv")
    renv::init(project = here())
    here()
  }
  
  else {
  # If renv file exists, restore stored packages
  renv::restore(project = here(),
                clean = TRUE,
                prompt = FALSE)
  
  }  
    
} else {
  
  # If renv file doesn't exist, check if pacman is not installed;
  # if yes, install & load, if not, just load.
  if (!require("pacman")) install.packages("pacman")
  library(pacman)
  
}

snapshot()

# Increase timeout for downloading packages in case of slow download speed
options(timeout = 300)

# Load all required packages
pacman::p_load(
  psych,
  osfr,
  tidyverse,
  skimr,
  naniar,
  ggpubr,
  rstatix,
  modelbased,
  performance,
  haven,
  MVN,
  ggrepel,
  see,
  lavaan,
  EFAtools,
  olsrr,
  random.polychor.pa,
  SEMsens
)

# install remotes if needed
# install.packages("remotes")

# install development version of dynamic from GitHub
remotes::install_github("melissagwolf/dynamic")
library(dynamic)

# Remove scientific notations
options(scipen = 999) 

snapshot()
```

#2. Data Load

```{r load clean data}
data <- read.csv(here("data", "data_clean", "data_cpa_clean.csv"))
```

#3. Composite Reliability

```{r t1}
omega_t1_1f <- data %>% 
  select(c(
  "cpa_1_t1", "cpa_2_t1","cpa_3_rs_t1","cpa_4_t1","cpa_5_rs_t1","cpa_6_t1",
  "cpa_7_t1","cpa_8_t1", "cpa_9_t1","cpa_10_t1","cpa_11_rs_t1", "cpa_12_t1")) %>% 
  psych::omega(nfactors = 1)

omega_t1_2f <- data %>% 
  select(c(
  "cpa_1_t1", "cpa_2_t1","cpa_3_rs_t1","cpa_4_t1","cpa_5_rs_t1","cpa_6_t1",
  "cpa_7_t1","cpa_8_t1", "cpa_9_t1","cpa_10_t1","cpa_11_rs_t1", "cpa_12_t1")) %>% 
  psych::omega(nfactors = 2)

omega_t1_3f <- data %>% 
  select(c(
  "cpa_1_t1", "cpa_2_t1","cpa_3_rs_t1","cpa_4_t1","cpa_5_rs_t1","cpa_6_t1",
  "cpa_7_t1","cpa_8_t1", "cpa_9_t1","cpa_10_t1","cpa_11_rs_t1", "cpa_12_t1")) %>% 
  psych::omega(nfactors = 3)

omega_t1_4f <- data %>% 
  select(c(
  "cpa_1_t1", "cpa_2_t1","cpa_3_rs_t1","cpa_4_t1","cpa_5_rs_t1","cpa_6_t1",
  "cpa_7_t1","cpa_8_t1", "cpa_9_t1","cpa_10_t1","cpa_11_rs_t1", "cpa_12_t1")) %>% 
  psych::omega(nfactors = 4)
```

```{r t2}
omega_t2_1f <- data %>% 
  select(c(
  "cpa_1_v2_t2","cpa_2_t2", "cpa_3_rs_t2", "cpa_4_t2", "cpa_5_v2_t2","cpa_6_t2",
  "cpa_7_t2", "cpa_8_t2", "cpa_9_t2","cpa_10_t2", "cpa_12_t2")) %>% 
  psych::omega(nfactors = 1)

omega_t2_2f <- data %>% 
  select(c(
  "cpa_1_v2_t2","cpa_2_t2", "cpa_3_rs_t2", "cpa_4_t2", "cpa_5_v2_t2","cpa_6_t2",
  "cpa_7_t2", "cpa_8_t2", "cpa_9_t2","cpa_10_t2", "cpa_12_t2")) %>% 
  psych::omega(nfactors = 2)

omega_t2_3f <- data %>% 
  select(c(
  "cpa_1_v2_t2","cpa_2_t2", "cpa_3_rs_t2", "cpa_4_t2", "cpa_5_v2_t2","cpa_6_t2",
  "cpa_7_t2", "cpa_8_t2", "cpa_9_t2","cpa_10_t2", "cpa_12_t2")) %>% 
  psych::omega(nfactors = 3)

omega_t2_4f <- data %>% 
  select(c(
  "cpa_1_v2_t2","cpa_2_t2", "cpa_3_rs_t2", "cpa_4_t2", "cpa_5_v2_t2","cpa_6_t2",
  "cpa_7_t2", "cpa_8_t2", "cpa_9_t2","cpa_10_t2", "cpa_12_t2")) %>% 
  psych::omega(nfactors = 4)
```

#4. DFI

```{r}

ord_vars <- c(
  "cpa_2_t1","cpa_3_rs_t1","cpa_4_t1","cpa_5_rs_t1","cpa_6_t1",
  "cpa_7_t1","cpa_9_t1","cpa_10_t1","cpa_12_t1",
  "cpa_1_v2_t2","cpa_2_t2","cpa_4_t2","cpa_5_v2_t2","cpa_6_t2",
  "cpa_7_t2","cpa_9_t2","cpa_10_t2","cpa_12_t2"
)

# 1. keep only variables you model
data_mod <- data %>%
  select(all_of(ord_vars))          # drop ID or accidental covariates

# 2. ensure they are INTEGER 1:4 and no stray 0/5/NA after recode
data_mod <- data_mod %>%
  mutate(across(everything(), ~ as.integer(.)))

## Longitudinal CFA model with corrected variable names
model_syntax <- '
  HE_T1 =~ cpa_3_rs_t1 + cpa_6_t1
  SH_T1 =~ cpa_5_rs_t1    + cpa_7_t1 + cpa_9_t1
  CO_T1 =~ cpa_2_t1    + cpa_4_t1 + cpa_10_t1 + cpa_12_t1

  HE_t2 =~ cpa_1_v2_t2 + cpa_6_t2
  SH_t2 =~ cpa_5_v2_t2 + cpa_7_t2 + cpa_9_t2
  CO_t2 =~ cpa_2_t2 + cpa_4_t2 + cpa_10_t2 + cpa_12_t2

  HE_T1 ~ 0*1
  SH_T1 ~ 0*1
  CO_T1 ~ 0*1
  HE_t2 ~ 1
  SH_t2 ~ 1
  CO_t2 ~ 1

  HE_T1 ~~ 1*HE_T1
  SH_T1 ~~ 1*SH_T1
  CO_T1 ~~ 1*CO_T1
  HE_t2 ~~ 1*HE_t2
  SH_t2 ~~ 1*SH_t2
  CO_t2 ~~ 1*CO_t2

  cpa_2_t1    ~~ 1*cpa_2_t1
  cpa_3_rs_t1 ~~ 1*cpa_3_rs_t1
  cpa_4_t1    ~~ 1*cpa_4_t1
  cpa_5_rs_t1    ~~ 1*cpa_5_rs_t1
  cpa_6_t1    ~~ 1*cpa_6_t1
  cpa_7_t1    ~~ 1*cpa_7_t1
  cpa_9_t1    ~~ 1*cpa_9_t1
  cpa_10_t1   ~~ 1*cpa_10_t1
  cpa_12_t1   ~~ 1*cpa_12_t1
  
cpa_1_v2_t2    ~~ cpa_1_v2_t2
cpa_2_t2    ~~ cpa_2_t2
cpa_4_t2    ~~ cpa_4_t2
cpa_5_v2_t2    ~~ cpa_5_v2_t2
cpa_6_t2    ~~ cpa_6_t2
cpa_7_t2    ~~ cpa_7_t2
cpa_9_t2    ~~ cpa_9_t2
cpa_10_t2   ~~ cpa_10_t2
cpa_12_t2   ~~ cpa_12_t2

  cpa_2_t1    ~~ cpa_2_t2
  cpa_3_rs_t1 ~~ cpa_1_v2_t2
  cpa_4_t1    ~~ cpa_4_t2
  cpa_5_rs_t1    ~~ cpa_5_v2_t2
  cpa_6_t1    ~~ cpa_6_t2
  cpa_7_t1    ~~ cpa_7_t2
  cpa_9_t1    ~~ cpa_9_t2
  cpa_10_t1   ~~ cpa_10_t2
  cpa_12_t1   ~~ cpa_12_t2

  cpa_3_rs_t1 | a1*t1 + t2 + t3
  cpa_1_v2_t2    | a1*t1 + t2 + t3

  cpa_2_t1    | a2*t1 + t2 + t3
  cpa_2_t2    | a2*t1 + t2 + t3

  cpa_4_t1    | a4*t1 + a4_2*t2 + t3
  cpa_4_t2    | a4*t1 + a4_2*t2 + t3

  cpa_5_rs_t1    | a5*t1 + t2 + t3
  cpa_5_v2_t2    | a5*t1 + t2 + t3

  cpa_6_t1    | a6*t1 + a6_2*t2 + t3
  cpa_6_t2    | a6*t1 + a6_2*t2 + t3

  cpa_7_t1    | a7*t1 + a7_2*t2 + t3
  cpa_7_t2    | a7*t1 + a7_2*t2 + t3

  cpa_9_t1    | a9*t1 + t2 + t3
  cpa_9_t2    | a9*t1 + t2 + t3

  cpa_10_t1   | a10*t1 + t2 + t3
  cpa_10_t2   | a10*t1 + t2 + t3

  cpa_12_t1   | a12*t1 + t2 + t3
  cpa_12_t2   | a12*t1 + t2 + t3
'

fit <- cfa(model_syntax,
           data         = data_mod,
           estimator    = "WLSMV",
           ordered      = ord_vars,
           parameterization = "theta",
           missing = "pairwise",
           auto.fix.first = FALSE,
           auto.var = TRUE,
           auto.cov.y = TRUE,
           auto.cov.lv.x = TRUE
           )

summary(fit)

dfi_results <- dynamic::DDDFI(fit,
                              scale = "categorical",
                              data = data_mod,
                              plot.dfi = TRUE,
                              plot.dist = TRUE,
                              plot.discrepancy = TRUE)
print(dfi_results)

```








