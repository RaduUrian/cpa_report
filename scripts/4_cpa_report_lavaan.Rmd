---
title: "4_cpa_report_lavaan"
output: html_document
---

#1. Setup

```{r Setup, include=FALSE}
# Sets pseudo random number generator seed to fixed value for reproducibility
set.seed(1)

# Check if package 'here' is installed; if not, install. 
if (!require("here")) install.packages("here")

# Load 'here' package
library(here)

# Check if renv file exists in project directory
if (file.exists(here("renv.lock")))

{
  
  if (!require("renv")) {
    
    install.packages("renv")
    renv::init(project = here())
    here()
  }
  
  else {
  # If renv file exists, restore stored packages
  renv::restore(project = here(),
                clean = TRUE,
                prompt = FALSE)
  
  }  
    
} else {
  
  # If renv file doesn't exist, check if pacman is not installed;
  # if yes, install & load, if not, just load.
  if (!require("pacman")) install.packages("pacman")
  library(pacman)
  
}

snapshot()

# Increase timeout for downloading packages in case of slow download speed
options(timeout = 300)

# Load all required packages
pacman::p_load(
  psych,
  osfr,
  tidyverse,
  skimr,
  naniar,
  ggpubr,
  rstatix,
  modelbased,
  performance,
  haven,
  MVN,
  ggrepel,
  see,
  lavaan,
  EFAtools,
  olsrr,
  random.polychor.pa,
  SEMsens
)

# install remotes if needed
# install.packages("remotes")

# install development version of dynamic from GitHub
remotes::install_github("melissagwolf/dynamic")
library(dynamic)

# Remove scientific notations
options(scipen = 999) 

snapshot()
```

#2. Data Load

```{r load clean data}
data <- read.csv(here("data", "data_clean", "data_cpa_clean.csv"))
```

#3. Model

```{r}

ord_vars <- c(
  "CPA_2_t1","CPA_3_RS_t1","CPA_4_t1","CPA_5_RS","CPA_6_t1",
  "CPA_7_t1","CPA_9_t1","CPA_10_t1","CPA_12_t1",
  "CPA_1_V2","CPA_2_t2","CPA_4_t2","CPA_5_V2","CPA_6_t2",
  "CPA_7_t2","CPA_9_t2","CPA_10_t2","CPA_12_t2"
)

# 1. keep only variables you model
data_mod <- data %>%
  select(all_of(ord_vars))          # drop ID or accidental covariates

# 2. ensure they are INTEGER 1:4 and no stray 0/5/NA after recode
data_mod <- data_mod %>%
  mutate(across(everything(), ~ as.integer(.)))

## Longitudinal CFA model with corrected variable names
model_syntax <- '
  HE_T1 =~ CPA_3_RS_t1 + CPA_6_t1
  SH_T1 =~ CPA_5_RS    + CPA_7_t1 + CPA_9_t1
  CO_T1 =~ CPA_2_t1    + CPA_4_t1 + CPA_10_t1 + CPA_12_t1

  HE_T2 =~ CPA_1_V2 + CPA_6_t2
  SH_T2 =~ CPA_5_V2 + CPA_7_t2 + CPA_9_t2
  CO_T2 =~ CPA_2_t2 + CPA_4_t2 + CPA_10_t2 + CPA_12_t2

  HE_T1 ~ 0*1
  SH_T1 ~ 0*1
  CO_T1 ~ 0*1
  HE_T2 ~ 1
  SH_T2 ~ 1
  CO_T2 ~ 1

  HE_T1 ~~ 1*HE_T1
  SH_T1 ~~ 1*SH_T1
  CO_T1 ~~ 1*CO_T1
  HE_T2 ~~ 1*HE_T2
  SH_T2 ~~ 1*SH_T2
  CO_T2 ~~ 1*CO_T2

  CPA_2_t1    ~~ 1*CPA_2_t1
  CPA_3_RS_t1 ~~ 1*CPA_3_RS_t1
  CPA_4_t1    ~~ 1*CPA_4_t1
  CPA_5_RS    ~~ 1*CPA_5_RS
  CPA_6_t1    ~~ 1*CPA_6_t1
  CPA_7_t1    ~~ 1*CPA_7_t1
  CPA_9_t1    ~~ 1*CPA_9_t1
  CPA_10_t1   ~~ 1*CPA_10_t1
  CPA_12_t1   ~~ 1*CPA_12_t1
  
CPA_1_V2    ~~ CPA_1_V2
CPA_2_t2    ~~ CPA_2_t2
CPA_4_t2    ~~ CPA_4_t2
CPA_5_V2    ~~ CPA_5_V2
CPA_6_t2    ~~ CPA_6_t2
CPA_7_t2    ~~ CPA_7_t2
CPA_9_t2    ~~ CPA_9_t2
CPA_10_t2   ~~ CPA_10_t2
CPA_12_t2   ~~ CPA_12_t2

  CPA_2_t1    ~~ CPA_2_t2
  CPA_3_RS_t1 ~~ CPA_1_V2
  CPA_4_t1    ~~ CPA_4_t2
  CPA_5_RS    ~~ CPA_5_V2
  CPA_6_t1    ~~ CPA_6_t2
  CPA_7_t1    ~~ CPA_7_t2
  CPA_9_t1    ~~ CPA_9_t2
  CPA_10_t1   ~~ CPA_10_t2
  CPA_12_t1   ~~ CPA_12_t2

  CPA_3_RS_t1 | a1*t1 + t2 + t3
  CPA_1_V2    | a1*t1 + t2 + t3

  CPA_2_t1    | a2*t1 + t2 + t3
  CPA_2_t2    | a2*t1 + t2 + t3

  CPA_4_t1    | a4*t1 + a4_2*t2 + t3
  CPA_4_t2    | a4*t1 + a4_2*t2 + t3

  CPA_5_RS    | a5*t1 + t2 + t3
  CPA_5_V2    | a5*t1 + t2 + t3

  CPA_6_t1    | a6*t1 + a6_2*t2 + t3
  CPA_6_t2    | a6*t1 + a6_2*t2 + t3

  CPA_7_t1    | a7*t1 + a7_2*t2 + t3
  CPA_7_t2    | a7*t1 + a7_2*t2 + t3

  CPA_9_t1    | a9*t1 + t2 + t3
  CPA_9_t2    | a9*t1 + t2 + t3

  CPA_10_t1   | a10*t1 + t2 + t3
  CPA_10_t2   | a10*t1 + t2 + t3

  CPA_12_t1   | a12*t1 + t2 + t3
  CPA_12_t2   | a12*t1 + t2 + t3
'


## To fit the model, read your data (e.g., data_ora_cpa.csv), convert the
## ordinal items to ordered factors, and call cfa() with the WLSMV
## estimator and theta parameterisation:
# mydata <- read.csv("data_ora_cpa.csv")
data_mod[ord_vars] <- lapply(data_mod[ord_vars], ordered)
fit <- cfa(model_syntax,
           data         = data_mod,
           estimator    = "WLSMV",
           ordered      = ord_vars,
           parameterization = "theta",
           missing = "pairwise",
           auto.fix.first = FALSE,
           auto.var = TRUE,
           auto.cov.y = TRUE,
           auto.cov.lv.x = TRUE,
           mimic = "Mplus"
           )

summary(fit)

dfi_results <- dynamic::DDDFI(fit,
                              scale = "categorical",
                              data = data_mod)
print(dfi_results)

```

```{r}
# assuming you've already fit 'fit' with WLSMV + ordered + theta
pe  <- parameterEstimates(fit, standardized = TRUE)
ss  <- standardizedSolution(fit)  # includes est.std

write.csv(pe, here("stand_est.csv"))

# Any NA loadings?
nas_load <- subset(ss, op == "=~" & is.na(est.std))
nas_load

# Any NA thresholds?
nas_thr  <- subset(pe, op == "|" & is.na(est))
nas_thr

# Any NA factor covariances (catHB also uses these)?
nas_latcov <- subset(ss, op == "~~" & lhs != rhs & is.na(est.std))
nas_latcov

for (v in ord_vars) {
  cat("\n", v, "\n"); print(table(data_mod[[v]], useNA = "ifany"))
}


```

```{r}
model_catHB <- "
HE_T1=~.459*CPA_3_RS_t1 + .826*CPA_6_t1
SH_T1=~.435*CPA_5_RS + .718*CPA_7_t1 + .858*CPA_9_t1
CO_T1=~.638*CPA_10_t1 + .740*CPA_12_t1 + .800*CPA_2_t1 + .822*CPA_4_t1
HE_T2=~.781*CPA_1_V2 + .576*CPA_6_t2
SH_T2=~.517*CPA_5_V2 + .780*CPA_7_t2 + .815*CPA_9_t2
CO_T2=~.712*CPA_10_t2 + .717*CPA_12_t2 + .696*CPA_2_t2 + .802*CPA_4_t2

# factor covariances (correlations)
HE_T1~~.326*SH_T1
HE_T1~~.307*CO_T1
HE_T1~~.475*HE_T2
HE_T1~~.171*SH_T2
HE_T1~~.051*CO_T2
SH_T1~~.392*CO_T1
SH_T1~~.259*HE_T2
SH_T1~~.550*SH_T2
SH_T1~~.266*CO_T2
CO_T1~~.200*HE_T2
CO_T1~~.197*SH_T2
CO_T1~~.576*CO_T2
HE_T2~~.553*SH_T2
HE_T2~~.432*CO_T2
SH_T2~~.393*CO_T2

# correlated uniquenesses (T1â€“T2 residual covariances)
CPA_2_t1~~.210*CPA_2_t2
CPA_4_t1~~.316*CPA_4_t2
CPA_5_RS~~.053*CPA_5_V2
CPA_6_t1~~.576*CPA_6_t2
CPA_7_t1~~.237*CPA_7_t2
CPA_9_t1~~.011*CPA_9_t2
CPA_10_t1~~.254*CPA_10_t2
CPA_12_t1~~.261*CPA_12_t2
CPA_3_RS_t1~~.049*CPA_1_V2

# thresholds (three per item)
CPA_10_t1 | -1.727*t1
CPA_10_t1 | -.141*t2
CPA_10_t1 | 1.510*t3
CPA_10_t2 | -1.727*t1
CPA_10_t2 | -.318*t2
CPA_10_t2 | .967*t3
CPA_12_t1 | -.710*t1
CPA_12_t1 | .633*t2
CPA_12_t1 | 2.264*t3
CPA_12_t2 | -.710*t1
CPA_12_t2 | .690*t2
CPA_12_t2 | 2.363*t3
CPA_1_V2 | -1.122*t1
CPA_1_V2 | -.174*t2
CPA_1_V2 | .534*t3
CPA_2_t1 | -2.014*t1
CPA_2_t1 | -.044*t2
CPA_2_t1 | 1.753*t3
CPA_2_t2 | -2.014*t1
CPA_2_t2 | -.255*t2
CPA_2_t2 | 1.353*t3
CPA_3_RS_t1 | -1.122*t1
CPA_3_RS_t1 | .016*t2
CPA_3_RS_t1 | 1.256*t3
CPA_4_t1 | -2.747*t1
CPA_4_t1 | -.874*t2
CPA_4_t1 | .999*t3
CPA_4_t2 | -2.747*t1
CPA_4_t2 | -.874*t2
CPA_4_t2 | .879*t3
CPA_5_RS | -1.480*t1
CPA_5_RS | -.660*t2
CPA_5_RS | .263*t3
CPA_5_V2 | -1.480*t1
CPA_5_V2 | -.253*t2
CPA_5_V2 | .735*t3
CPA_6_t1 | -1.666*t1
CPA_6_t1 | .349*t2
CPA_6_t1 | 1.927*t3
CPA_6_t2 | -1.666*t1
CPA_6_t2 | .349*t2
CPA_6_t2 | 2.054*t3
CPA_7_t1 | -1.134*t1
CPA_7_t1 | .467*t2
CPA_7_t1 | 1.690*t3
CPA_7_t2 | -1.134*t1
CPA_7_t2 | .467*t2
CPA_7_t2 | 1.969*t3
CPA_9_t1 | -3.038*t1
CPA_9_t1 | -1.165*t2
CPA_9_t1 | .894*t3
CPA_9_t2 | -3.038*t1
CPA_9_t2 | -.974*t2
CPA_9_t2 | .886*t3
"

```

```{r}
library(dynamic)
dfi <- catHB(
  model     = model_catHB,   # the string below
  n         = 470,           # your used N
  manual    = TRUE,
  estimator = "WLSMV",
  plot      = TRUE
)
dfi


```

```{r}
bundle <- list(
  fit            = fit,                # your fitted lavaan object
  ord_vars       = ord_vars,           # the ordered indicators vector you used
  model_syntax   = model_syntax,       # the exact syntax string
  n_used         = nobs(fit),          # N used (e.g., 470)
  lavaan_version = as.character(packageVersion("lavaan")),
  dynamic_version= if (requireNamespace("dynamic", quietly=TRUE))
                     as.character(utils::packageVersion("dynamic")) else NA_character_,
  sessionInfo    = utils::sessionInfo()
)

saveRDS(bundle, file = here("lavaan_fit_bundle.rds"))
```

```{r}
dat <- lavaan::HolzingerSwineford1939

dat <- dat %>% 
  mutate(
    across(
      x1:x9,
      ~as.integer(.)
    )
  )

# 2) CFA model with categorical indicators + correlated uniquenesses
lavmod_cat <- "
  F1 =~ x1 + x2 + x3
  F2 =~ x4 + x5 + x6
  F3 =~ x7 + x8 + x9

  # correlated uniquenesses (residual covariances among items)
  x1 ~~ x2
  x4 ~~ x5
  x7 ~~ x8
"

fit_cat <- cfa(
  lavmod_cat, data = dat,
  ordered = TRUE,
  estimator = "WLSMV",
  parameterization = "theta",
  std.lv = TRUE
)

summary(fit_cat, fit.measures = TRUE, standardized = TRUE)
catHB(fit_cat)
```







